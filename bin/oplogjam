#!/usr/bin/env ruby

require 'logger'
require 'yaml'
require 'mongo'
require 'oplogjam'

mongodb_uri, postgres_uri, config = ARGV

logger = Logger.new(STDOUT)
logger.info('oplogjam'.freeze) { "Connecting to MongoDB at #{mongodb_uri}" }

mongodb = Mongo::Client.new(mongodb_uri)
oplog = Oplogjam::Oplog.new(mongodb)

logger.info('oplogjam'.freeze) { "Connecting to PostgreSQL at #{postgres_uri}" }
postgres = Sequel.connect(postgres_uri)

logger.info('oplogjam'.freeze) { "Reading configuration from #{config}" }
config = Oplogjam::Configuration.new(postgres).load(YAML.load_file(config))

progress = config.progress
mapping = config.mapping

begin
  oplog.since(progress).each do |operation|
    postgres.transaction do
      operation.apply(mapping)

      logger.debug('oplogjam'.freeze) { "Recording #{operation.timestamp}" }
      progress.record(operation)
    end
  end
rescue => e
  logger.error('oplogjam'.freeze) { "Something went wrong when tailing, retrying: #{e}" }

  retry
end
