#!/usr/bin/env ruby

require 'oplogjam'
require 'mongo'

mongodb_uri, postgres_uri = ARGV

mongodb = Mongo::Client.new(mongodb_uri)
oplog = Oplogjam::Oplog.new(mongodb)

postgres = Sequel.connect(postgres_uri)
progress = Oplogjam::Progress.new(postgres)

begin
  oplog.since(progress).each do |operation|
    $stdout << '.'

    postgres.transaction do
      operation.apply(postgres)
      progress.record(operation)
    end
  end
rescue => e
  $stderr.puts "Something went wrong, retrying: #{e}"

  retry
end
