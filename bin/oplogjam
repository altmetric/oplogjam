#!/usr/bin/env ruby

require 'oplogjam'
require 'mongo'

mongodb_uri, postgres_uri = ARGV

mongodb = Mongo::Client.new(mongodb_uri)
postgres = Sequel.connect(postgres_uri)
oplog = Oplogjam::Oplog.new(mongodb)

postgres.from(:oplogjam).insert(seconds: 0, increment: 0) if postgres.from(:oplogjam).empty?

def query(postgres)
  progress = postgres.from(:oplogjam).first
  return {} unless progress

  { 'ts' => { '$gt' => BSON::Timestamp.new(progress.fetch(:seconds), progress.fetch(:increment)) } }
end

begin
  oplog.oplog(query(postgres)).each do |operation|
    puts operation.to_sql
    operation.apply(postgres)
    postgres.from(:oplogjam).update(seconds: operation.ts.seconds, increment: operation.ts.increment)
  end
rescue => e
  $stderr.puts "Something went wrong, retrying: #{e}"

  retry
end
